const path = require('path');
const fs = require('fs');

const saveData = (cd, folder, bool) => {
    fs.readFile(cd, (err, users) => {
        if (err) {
            console.error(err);
        } else {

            fs.mkdir(path.join(__dirname + `/../${folder}/`), (err) => {
                if (err) {
                    if (err.code === 'EEXIST') {
                        console.log('ten folder już istnieje');
                        return;
                    }
                    console.error(err);
                } else {
                    console.log('stworzono nowy folder');
                }
            })

            let usersObj = JSON.parse(users)

            for (const user of usersObj) {

                let userPath = path.join(__dirname + `/../${folder}/` + (user.id) + `-` + (user.name.replace(/\s/g, "-")) + `.txt`);
                let userPathExists = fs.existsSync(userPath);

                if ((userPathExists && bool) || (!userPathExists)) {

                    fs.writeFile(userPath,
                        `Name: ${user.name.split(' ')[0]} ${user.name.split(' ')[0] === ('Mrs.' || 'Ms.') ? user.name.split(' ')[1] : ''} 
Surname: ${user.name.split(' ')[0] === ('Mrs.' || 'Ms.') ? user.name.split(' ')[2] : user.name.split(' ')[1]} ${user.name.split(' ')[2] && user.name.split(' ')[0] !== ('Mrs.' || 'Ms.') ? user.name.split(' ')[2] : ''}
Street: ${user.address.street} 
Zip Code: ${user.address.zipcode} 
City: ${user.address.city} 
Phone: ${user.phone}`, (err) => {
                        if (err) {
                            console.error(err);
                        } else {
                            console.log('stworzono użytkownika');
                        }
                    })
                } else {
                    console.log(`Użytkownik ${user.name} już istnieje`);
                }
            };
        }
    })
}

module.exports = {
    saveData: saveData,
}